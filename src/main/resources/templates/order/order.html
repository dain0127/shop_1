<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>주문 확인</title>
</head>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            calculateTotalPrice();
        });

        function calculateTotalPrice(){
            let totalPrice = 0;
            $("span[name=orderPrice]").each(function(){
                totalPrice += parseInt($(this).data("price"));
            });
            $("#orderTotalPrice").html(totalPrice.toLocaleString() + "원");
        }

        function orderConfirm(){
            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");

            let url = "/orders";

            let dataList = [];
            $("input[name=cartItemId]").each(function(){
                dataList.push({
                    cartItemId: $(this).val()
                });
            });

            let param = JSON.stringify({ cartOrderDtoList : dataList });

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data : param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                success : function(){
                    alert("주문이 완료되었습니다.");
                    location.href="/orders";
                },
                error : function(jqXHR){
                    if(jqXHR.status === 401){
                        alert("로그인 후 이용해주세요.");
                        location.href="/members/login";
                    }else{
                        alert(jqXHR.responseText);
                    }
                }
            });
        }
    </script>
</th:block>

<th:block layout:fragment="css">
    <style>
        .content-mg{
            margin: 3% 25% 100px 25%;
        }
        .repImg{
            width:80px;
            height:80px;
        }
    </style>
</th:block>

<div layout:fragment="content" class="content-mg">

    <h2 class="mb-4">주문 상품 확인</h2>

    <table class="table">
        <thead class="text-center">
        <tr>
            <th>상품정보</th>
            <th>수량</th>
            <th>금액</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="orderItem : ${orderItemList}">
            <td class="d-flex align-items-center">
                <img th:src="${orderItem.imgUrl}" class="repImg rounded me-3">
                <span th:text="${orderItem.itemNm}"></span>
            </td>
            <td class="text-center" th:text="${orderItem.count}"></td>
            <td class="text-center">
                <span name="orderPrice"
                      th:data-price="${orderItem.orderPrice}"
                      th:text="${#numbers.formatInteger(orderItem.orderPrice,3,'COMMA')} + '원'">
                </span>
            </td>

            <!-- 주문에 필요한 cartItemId -->
            <input type="hidden" name="cartItemId" th:value="${orderItem.cartItemId}">
        </tr>
        </tbody>
    </table>

    <hr>

    <h3 class="text-end">
        총 결제 금액 :
        <span id="orderTotalPrice" class="text-danger"></span>
    </h3>

    <div class="text-center mt-4">
        <button class="btn btn-secondary btn-lg me-2" onclick="history.back()">취소</button>
        <button class="btn btn-primary btn-lg" onclick="orderConfirm()">결제하기</button>
    </div>

</div>

</html>