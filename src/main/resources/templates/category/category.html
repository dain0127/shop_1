<!DOCTYPE html>
<html lang="en"
      xmlns:th = "http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title>카테고리 추가</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
        }

        h2 {
            margin-bottom: 15px;
        }

        .container {
            display: flex;
            gap: 50px;
        }

        .form-box {
            width: 300px;
        }

        .tree-box {
            border: 1px solid #ccc;
            padding: 15px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        ul {
            list-style: none;
            padding-left: 20px;
        }

        li {
            margin: 5px 0;
        }

        label {
            cursor: pointer;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #444;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #222;
        }
    </style>

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>
<th:block layout:fragment="script">

    <script th:inline="javascript">

        function deleteCategory(obj){
            console.log(obj);
            alert(obj.dataset.categoryId);

            var categoryId = Number(obj.dataset.categoryId);
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/admin/category/delete/" + categoryId;
            $.ajax({
                url: url,
                type: "DELETE",
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function(result, status){
                    location.href = '/admin/category/new';
                },
                error: function(jqXHR, status, error){
                    if(jqXHR.status == 401){
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseJSON.message);
                    }
                }
            });
        }

        function updateCategory(obj){
            console.log(obj);
            console.log(obj.dataset.categoryId);

            var categoryId = Number(obj.dataset.categoryId);
            //카테고리 이름
            var newCategoryName = obj.closest("tr")
                   .querySelector(".category-name-input").value;

            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            if (!newCategoryName.trim()) {
                alert("카테고리 이름을 입력하세요");
                return;
            }

            var url = "/admin/category/update/" + categoryId;
            $.ajax({
                url: url,
                type: "PATCH",
                data: {
                    newCategoryName: newCategoryName
                },
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function(result, status){
                    alert("수정 완료");
                    location.href = '/admin/category/new';
                },
                error: function(jqXHR, status, error){
                    alert("수정 실패");
                    if(jqXHR.status == 401){
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseJSON.message);
                    }
                }
            });
        }
    </script>
</th:block>



    <div layout:fragment="content">
        <h2>카테고리 추가</h2>

        <form th:action="@{/admin/category/new}" method="post">
            <!-- 카테고리 이름 -->
            <div class="form-group">
                <label for="name">카테고리 이름</label>
                <input type="text" id="name" name="categoryNm"
                       placeholder="카테고리 이름 입력" required>
            </div>

            <button type="submit">카테고리 추가</button>
        </form>

        <!-- 카테고리 목록 -->
        <div class="form-group">
            <h3>카테고리 목록</h3>
            <table>
                <tr th:each="cat : ${categories}">
<!--                    <td th:text="${cat.categoryNm}"></td>-->
                    <td><input type="text" th:value="${cat.categoryNm}" size="8"
                               class="category-name-input">
                    </td>
                    <td>
                        <button type="button" class="close" aria-label="Close"
                                th:data-category-id="${cat.categoryId}"
                                onclick="updateCategory(this)">
                            <span aria-hidden="true">수정</span>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="close" aria-label="Close"
                                th:data-category-id="${cat.categoryId}"
                                onclick="deleteCategory(this)">
                            <span aria-hidden="true">삭제</span>
                        </button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>